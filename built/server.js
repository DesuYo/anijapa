!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("babel-polyfill")},function(e,t,r){"use strict";r.r(t);r(10);var n=r(6),o=r(2),u=r(4),a=r(7),i=r(8),c=r(9),s=r(0),p=r.n(s),f=p.a.model("user",new s.Schema({googleID:{type:String,unique:!0},permissions:[String],username:{type:String,sparse:!0},photo:String,firstName:String,lastName:String,birthDate:Date},{timestamps:!0}).pre("save",function(){})),d=s.Schema.Types.ObjectId,l=new s.Schema({text:String,userId:{type:d,ref:"User"},animeId:{type:d,ref:"Anime"},likes:[{type:d,ref:"User"}],replies:[{type:d,ref:"Comment"}]},{timestamps:!0}),m=p.a.model("comment",l),v={users:f,comments:m};function h(e,t,r,n,o,u,a){try{var i=e[u](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}var b=function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var u=e.apply(t,r);function a(e){h(u,n,o,a,i,"next",e)}function i(e){h(u,n,o,a,i,"throw",e)}a(void 0)})}}(regeneratorRuntime.mark(function e(t,r,n){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=process.env.DB_URI,e.next=4,Object(s.connect)(o,{useNewUrlParser:!0});case 4:return t.db=v,e.abrupt("return",n());case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",n(e.t0));case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}(),y=r(3),g=r(5),w=r(1);function x(e){return(x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function O(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function j(e,t){return!t||"object"!==x(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&E(e,t)}function k(e){var t="function"==typeof Map?new Map:void 0;return(k=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return R(e,arguments,S(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),E(r,e)})(e)}function R(e,t,r){return(R=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&E(o,r.prototype),o}).apply(null,arguments)}function E(e,t){return(E=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var P=function(e){function t(e){return O(this,t),j(this,S(t).call(this,e))}return _(t,k(Error)),t}(),I=function(e){function t(){return O(this,t),j(this,S(t).call(this,"Permission denied for this action."))}return _(t,k(Error)),t}();function T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,o=!1,u=void 0;try{for(var a,i=e[Symbol.iterator]();!(n=(a=i.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){o=!0,u=e}finally{try{n||null==i.return||i.return()}finally{if(o)throw u}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function q(e,t,r,n,o,u,a){try{var i=e[u](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function D(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var u=e.apply(t,r);function a(e){q(u,n,o,a,i,"next",e)}function i(e){q(u,n,o,a,i,"throw",e)}a(void 0)})}}var N=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(){var e=D(regeneratorRuntime.mark(function e(r,n,o){var u,a,i,c,s,p,d,l,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,u=r.headers.authorization){e.next=4;break}return e.abrupt("return",o(new y.JsonWebTokenError("Bearer token is required!")));case 4:if(a=u.split(" "),i=T(a,2),c=i[0],s=i[1],"Bearer"===c){e.next=7;break}return e.abrupt("return",o(new y.JsonWebTokenError("Bearer token is required!")));case 7:return p=Object(y.verify)(s,process.env.JWT_SECRET||"難しい鍵"),d=p._id,e.next=10,f.findById(d,{__v:0}).exec();case 10:if(l=e.sent){e.next=13;break}return e.abrupt("return",o(new y.JsonWebTokenError("User with this token does not exist")));case 13:if(m=l.toObject(),(m.permissions||[]).some(function(e){return t.includes(e)||"overlord"===e})){e.next=17;break}return e.abrupt("return",o(new I));case 17:return r.user=m,e.abrupt("return",o());case 21:return e.prev=21,e.t0=e.catch(0),e.abrupt("return",o(e.t0));case 24:case"end":return e.stop()}},e,this,[[0,21]])}));return function(t,r,n){return e.apply(this,arguments)}}()};function B(e,t,r,n,o,u,a){try{var i=e[u](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}var U=function(e){return w.string().trim().max(e)},A=function(e){return U(e).required()},G=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;return U(64).guid().default(e)},M=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return w.array().items(t).default([])},J=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return U(e).token().lowercase().default(t)},L=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return U(e).uri({allowRelative:!0}).default(t)},W=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return U(e).regex(/^[a-zA-Z]$/).default(t)},$=function(e){return function(){var t=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var u=e.apply(t,r);function a(e){B(u,n,o,a,i,"next",e)}function i(e){B(u,n,o,a,i,"throw",e)}a(void 0)})}}(regeneratorRuntime.mark(function t(r,n,o){var u,a,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,u=w.compile(e).options({abortEarly:!1,allowUnknown:!0,stripUnknown:!0}).validate(r.body),a=u.error,i=u.value,a&&o(a),r.body=i,t.abrupt("return",o());case 7:t.prev=7,t.t0=t.catch(0),o(t.t0);case 10:case"end":return t.stop()}},t,this,[[0,7]])}));return function(e,r,n){return t.apply(this,arguments)}}()};function C(e,t,r,n,o,u,a){try{var i=e[u](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function F(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var u=e.apply(t,r);function a(e){C(u,n,o,a,i,"next",e)}function i(e){C(u,n,o,a,i,"throw",e)}a(void 0)})}}var z=Object(o.Router)().get("/me",N("get:basic","get:admin"),function(){var e=F(regeneratorRuntime.mark(function e(t,r,n){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.user,e.abrupt("return",r.status(200).json(o));case 5:e.prev=5,e.t0=e.catch(0),n(e.t0);case 8:case"end":return e.stop()}},e,this,[[0,5]])}));return function(t,r,n){return e.apply(this,arguments)}}()).patch("/me",N("patch:basic","patch:admin"),$({username:J(16),photo:L(256),firstName:W(16),lastName:W(16)}),function(){var e=F(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.user,a=t.body,e.next=4,o.users.updateOne({_id:u._id},{$set:a}).exec();case 4:return i=e.sent,e.abrupt("return",r.status(200).json({message:"Modified ".concat(i.ok," document[s]")}));case 8:e.prev=8,e.t0=e.catch(0),n(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}()).delete("/me",N("delete:basic","delete:admin"),function(){var e=F(regeneratorRuntime.mark(function e(t,r,n){var o,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.user,e.next=4,o.users.deleteOne({_id:u._id}).exec();case 4:r.status(204).end(),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),n(e.t0);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(t,r,n){return e.apply(this,arguments)}}()).get("/users",N("get:admin"),function(){var e=F(regeneratorRuntime.mark(function e(t,r,n){var o,u,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.query,e.next=4,o.users.find({username:new RegExp(".*".concat(u.username,".*")),firstName:new RegExp(".*".concat(u.firstName,".*")),lastName:new RegExp(".*".concat(u.lastName,".*"))}).exec();case 4:return a=e.sent,e.abrupt("return",r.status(200).json(a));case 8:e.prev=8,e.t0=e.catch(0),n(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}()).patch("/users/:id",N("patch:admin"),$({permissions:M(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return w.allow(t)}(["get:basic","post:basic","patch:basic","delete:basic","get:admin","post:admin","patch:admin","delete:admin"])),username:J(16),photo:L(256),firstName:W(16),lastName:W(16)}),function(){var e=F(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.params,a=t.body,e.next=4,o.users.findById(u.id).exec();case 4:if(i=e.sent){e.next=7;break}return e.abrupt("return",n(new P("User not found")));case 7:if(!i.toObject().permissions.some(function(e){return"overlord"===e})){e.next=9;break}return e.abrupt("return",n(new I));case 9:return e.next=11,i.update({$set:a}).exec();case 11:return e.abrupt("return",r.status(204).end());case 14:e.prev=14,e.t0=e.catch(0),n(e.t0);case 17:case"end":return e.stop()}},e,this,[[0,14]])}));return function(t,r,n){return e.apply(this,arguments)}}());function V(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Z(e,t,r[t])})}return e}function Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function H(e,t,r,n,o,u,a){try{var i=e[u](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function K(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var u=e.apply(t,r);function a(e){H(u,n,o,a,i,"next",e)}function i(e){H(u,n,o,a,i,"throw",e)}a(void 0)})}}var Q=Object(o.Router)().patch("/:id/likes",N("patch:basic","patch:admin"),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.user,a=t.params,e.next=4,o.comments.findById(a.id).exec();case 4:return i=e.sent,c=i.toObject().likes.includes(u._id)?"$pull":"$push",e.next=8,o.comments.findByIdAndUpdate(a.id,Z({},c,{likes:u._id}),{new:!0}).exec();case 8:return s=e.sent,e.abrupt("return",r.status(200).json(s));case 12:e.prev=12,e.t0=e.catch(0),n(e.t0);case 15:case"end":return e.stop()}},e,this,[[0,12]])}));return function(t,r,n){return e.apply(this,arguments)}}()).post("/",N("post:basic","post:admin"),$({text:A(300),animeId:U(64).guid().required(),replies:M(G()),likes:M(G())}),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.body,u=t.user,a=t.db,i=new a.comments(V({},o,{userId:u._id})),e.t0=r.status(201),e.next=6,i.save();case 6:return e.t1=e.sent,e.abrupt("return",e.t0.json.call(e.t0,e.t1));case 10:e.prev=10,e.t2=e.catch(0),n(e.t2);case 13:case"end":return e.stop()}},e,this,[[0,10]])}));return function(t,r,n){return e.apply(this,arguments)}}()).patch("/:id",N("patch:basic","patch:admin"),$({text:A(300)}),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.user,a=t.params,i=t.body,e.next=4,o.comment.updateOne({_id:a.id,userId:u._id},{$set:{text:i.text}},{new:!0}).exec();case 4:return c=e.sent,e.abrupt("return",r.status(c.ok<1?400:200).json({result:c}));case 8:e.prev=8,e.t0=e.catch(0),n(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}()).delete("/:id",N("delete:basic","delete:admin"),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.user,a=t.params,e.next=4,o.comment.deleteOne({_id:a.id,userId:u._id}).error();case 4:return i=e.sent,e.abrupt("return",r.status(204).json(i));case 8:e.prev=8,e.t0=e.catch(0),n(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}()).delete("/:id",N("delete:admin"),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.db,u=t.params,e.next=4,o.comment.deleteOne({_id:u.id}).error();case 4:return a=e.sent,e.abrupt("return",r.status(204).json(a));case 8:e.prev=8,e.t0=e.catch(0),n(e.t0);case 11:case"end":return e.stop()}},e,this,[[0,8]])}));return function(t,r,n){return e.apply(this,arguments)}}()).get("/",N("get:admin"),function(){var e=K(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i,c,s,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.query,u=o.text,a=void 0===u?"":u,i=o.userId,c=void 0===i?"":i,s=t.db,e.next=5,s.comment.find({text:new RegExp(".*".concat(a,".*")),userId:new RegExp(".*".concat(c,".*"))});case 5:return p=e.sent,e.abrupt("return",r.status(204).json(p));case 9:e.prev=9,e.t0=e.catch(0),n(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(t,r,n){return e.apply(this,arguments)}}()),X=Object(o.Router)().use("/",z).use("/anime/:animeId/comments",Q);n.config();var Y=process.env.PORT,ee=void 0===Y?777:Y;t.default=o().use(i("dev")).use(a()).use("/static",o.static("built/public")).use(u.json()).use(u.urlencoded({extended:!0})).use(b).get("/google",function(e){return function(t,r,n){try{var o=t.path,u=process.env.GOOGLE_ID;return r.redirect("https://accounts.google.com/o/oauth2/v2/auth"+"?client_id=".concat(u)+"&redirect_uri=https://".concat(t.get("host")).concat(o,"/callback")+"&scope=".concat(e)+"&response_type=code")}catch(e){n(e)}}}("https://www.googleapis.com/auth/userinfo.profile")).all("/google/callback",function(){var e=D(regeneratorRuntime.mark(function e(t,r,n){var o,u,a,i,c,s,p,f,d,l,m,v,h,b,w;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.path,u=t.query,a=t.db,i=process.env,c=i.GOOGLE_ID,s=i.GOOGLE_SECRET,p=i.GOOGLE_OVERLORD_PROFILE_ID,f=i.JWT_SECRET,e.next=5,g.post("https://www.googleapis.com/oauth2/v4/token").set("accept","application/json").set("content-type","application/x-www-form-urlencoded").send({client_id:c,client_secret:s,code:u.code,redirect_uri:"https://".concat(t.get("host")).concat(o),grant_type:"authorization_code"});case 5:return d=e.sent.body.access_token,e.next=8,g.get("https://www.googleapis.com/oauth2/v1/userinfo").set("accept","application/json").query({access_token:d});case 8:return l=e.sent.body,e.next=11,a.users.findOne({googleID:l.id}).exec();case 11:if(!(m=e.sent)){e.next=14;break}return e.abrupt("return",r.status(200).json({accessToken:Object(y.sign)({_id:m.toObject()._id},f,{expiresIn:"2d"}),tokenType:"Bearer"}));case 14:return v=l.id,h=l.given_name,b=l.family_name,w=l.picture,e.next=17,a.users.create({googleID:v,permission:v==p?["overlord"]:["get:basic","post:basic","patch:basic","delete:basic"],photo:w,firstName:h,lastName:b});case 17:return m=e.sent,e.abrupt("return",r.status(201).json({accessToken:Object(y.sign)({_id:m.toObject()._id},f,{expiresIn:"2d"}),tokenType:"Bearer"}));case 21:return e.prev=21,e.t0=e.catch(0),e.abrupt("return",n(e.t0));case 24:case"end":return e.stop()}},e,this,[[0,21]])}));return function(t,r,n){return e.apply(this,arguments)}}()).use("/api",X).get("/",function(e,t){return t.status(200).sendFile(Object(c.join)(__dirname,"index.html"))}).use(function(e,t,r,n){try{switch(!0){case e instanceof y.JsonWebTokenError||e instanceof y.TokenExpiredError:return r.status(401).json({error:e});case e instanceof I:return r.status(403).json({error:e.message});case e.isJoi:return r.status(400).json(e.details.map(function(e){return{key:e.context.key,message:e.message}}));case"MongoError"===e.name&&11e3===e.code:return r.status(400).json({error:e.errmsg});case e instanceof P:return r.status(404).json({error:e.message});default:throw e}}catch(e){return r.status(500).json({error:e.message||e})}}).listen(ee,function(){return console.log("I'm gonna poop on the plate, bratok...")})}]);