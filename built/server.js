!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1);t.MongooseModel=r.Model,t.MongooseSchema=r.Schema;var o=n(6);t.JsonWebTokenError=o.JsonWebTokenError,t.TokenExpiredError=o.TokenExpiredError},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(6),i=n(5),s=n(17),a=n(4),u=n(2);t.possiblePermissions=["get:basic","post:basic","patch:basic","delete:basic","get:admin","post:admin","patch:admin","delete:admin"],t.googleAuthorize=(e=>(t,n,r)=>{try{const{path:o}=t,{GOOGLE_ID:i}=process.env;return n.redirect("https://accounts.google.com/o/oauth2/v2/auth"+`?client_id=${i}`+`&redirect_uri=https://${t.get("host")}${o}/callback`+`&scope=${e}`+"&response_type=code")}catch(e){r(e)}}),t.googleCallback=(()=>(e,t,n)=>r(this,void 0,void 0,function*(){try{const{path:r,query:i,db:a}=e,{GOOGLE_ID:u,GOOGLE_SECRET:c,GOOGLE_OVERLORD_PROFILE_ID:d,JWT_SECRET:l}=process.env,{access_token:f}=(yield s.post("https://www.googleapis.com/oauth2/v4/token").set("accept","application/json").set("content-type","application/x-www-form-urlencoded").send({client_id:u,client_secret:c,code:i.code,redirect_uri:`https://${e.get("host")}${r}`,grant_type:"authorization_code"})).body,p=(yield s.get("https://www.googleapis.com/oauth2/v1/userinfo").set("accept","application/json").query({access_token:f})).body;let m=yield a.users.findOne({googleID:p.id}).exec();if(m)return t.status(200).json({accessToken:o.sign({_id:m.toObject()._id},l,{expiresIn:"2d"}),tokenType:"Bearer"});const{id:h,given_name:y,family_name:v,picture:g}=p;return m=yield a.users.create({googleID:h,permission:h==d?["overlord"]:["get:basic","post:basic","patch:basic","delete:basic"],photo:g,firstName:y,lastName:v}),t.status(201).json({accessToken:o.sign({_id:m.toObject()._id},l,{expiresIn:"2d"}),tokenType:"Bearer"})}catch(e){return n(e)}})),t.default=((...e)=>(t,n,s)=>r(this,void 0,void 0,function*(){try{const{authorization:n}=t.headers;if(!n)return s(new u.JsonWebTokenError("Bearer token is required!"));const[r,c]=n.split(" ");if("Bearer"!==r)return s(new u.JsonWebTokenError("Bearer token is required!"));const{_id:d}=o.verify(c,process.env.JWT_SECRET||"難しい鍵"),l=yield i.default.findById(d,{__v:0}).exec();if(!l)return s(new u.JsonWebTokenError("User with this token does not exist"));const f=l.toObject();return(f.permissions||[]).some(t=>e.includes(t)||"overlord"===t)?(t.user=f,s()):s(new a.PermissionError)}catch(e){return s(e)}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(2);class o extends Error{constructor(e){super(e)}}t.NotFoundError=o;class i extends Error{constructor(){super("Permission denied for this action.")}}t.PermissionError=i,t.default=((e,t,n,s)=>{try{switch(!0){case e instanceof r.JsonWebTokenError||e instanceof r.TokenExpiredError:return n.status(401).json({error:e});case e instanceof i:return n.status(403).json({error:e.message});case e.isJoi:return n.status(400).json(e.details.map(e=>({key:e.context.key,message:e.message})));case"MongoError"===e.name&&11e3===e.code:return n.status(400).json({error:e.errmsg});case e instanceof o:return n.status(404).json({error:e.message});default:throw e}}catch(e){return n.status(500).json({error:e.message||e})}})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(2);t.default=r.model("user",new o.MongooseSchema({googleID:{type:String,unique:!0},permissions:[String],username:{type:String,sparse:!0},photo:String,firstName:String,lastName:String,birthDate:Date},{timestamps:!0}).pre("save",()=>{}))},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(20),i=e=>o.string().trim().max(e),s=e=>o.number().max(e),a=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$/;t.VARCHAR=((e,t)=>i(e).default(t)),t.$VARCHAR=(e=>i(e).required()),t.GUID=(e=>i(64).guid().default(e)),t.$GUID=(()=>i(64).guid().required()),t.ARRAY=((...e)=>o.array().items(e).default([])),t.$ARRAY=((...e)=>o.array().items(e).required()),t.ENUM=((...e)=>o.allow(e)),t.$ENUM=((...e)=>o.allow(e).required()),t.SLUG=((e,t)=>i(e).token().lowercase().default(t)),t.$SLUG=(e=>i(e).token().lowercase().required()),t.URI=((e,t)=>i(e).uri({allowRelative:!0}).default(t)),t.$URI=(e=>i(e).uri({allowRelative:!0}).required()),t.NAME=((e,t)=>i(e).regex(/^[a-zA-Z]$/).default(t)),t.$NAME=(e=>i(e).regex(/^[a-zA-Z]$/).required()),t.EMAIL=(e=>i(64).email().default(e)),t.$EMAIL=(()=>i(64).email().required()),t.PHONE=(e=>i(16).replace(/\(*\)*/g,"").regex(/^\+\d{11,12}$/).default(e)),t.$PHONE=(()=>i(16).replace(/\(*\)*/g,"").regex(/^\+\d{11,12}$/).required()),t.PASSWORD=((e,t)=>i(64).regex(a).min(e).default(t)),t.$PASSWORD=(e=>i(64).regex(a).min(e).required()),t.INT=((e=Math.pow(2,32),t)=>s(e).integer().default(t)),t.$INT=((e=Math.pow(2,32))=>s(e).integer().required()),t.UINT=((e=Math.pow(2,32),t)=>s(e).integer().positive().default(t)),t.$UINT=((e=Math.pow(2,32))=>s(e).integer().positive().required()),t.FLOAT=((e=Math.pow(2,32),t=3,n)=>s(e).precision(t).default(n)),t.$FLOAT=((e=Math.pow(2,32),t=3)=>s(e).precision(t).required()),t.UFLOAT=((e=Math.pow(2,32),t=3,n)=>s(e).precision(t).positive().default(n)),t.$UFLOAT=((e=Math.pow(2,32),t=3)=>s(e).precision(t).positive().required()),t.BOOL=(e=>o.boolean().default(e)),t.DATE=(e=>o.date().iso().default(e)),t.$DATE=(()=>o.date().iso().required()),t.validationHandler=(e=>(t,n,i)=>r(this,void 0,void 0,function*(){try{const{error:n,value:r}=o.compile(e).options({abortEarly:!1,allowUnknown:!0,stripUnknown:!0}).validate(t.body);return n&&i(n),t.body=r,i()}catch(e){i(e)}}))},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const r=n(9),o=n(0),i=n(10),s=n(11),a=n(12),u=n(13),c=n(14),d=n(3),l=n(18),f=n(4);r.config();const{PORT:p=777}=process.env;t.default=o().use(a("dev")).use(s()).use(o.static(u.join(e,"public"))).use(i.json()).use(i.urlencoded({extended:!0})).use(c.default).get("/google",d.googleAuthorize("https://www.googleapis.com/auth/userinfo.profile")).all("/google/callback",d.googleCallback()).use("/api",l.default).use((e,t)=>t.status(200).sendFile("/index.html")).use(f.default).listen(p,()=>console.log("I'm gonna poop on the plate, bratok..."))}).call(this,"/")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(1),i=n(15);t.default=((e,t,n)=>r(this,void 0,void 0,function*(){try{const{DB_URI:t}=process.env;return yield o.connect(t,{useNewUrlParser:!0}),e.db=i.default,n()}catch(e){return n(e)}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(5),o=n(16);t.default={users:r.default,comments:o.default}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(2),i=r.Schema.Types.ObjectId,s=new o.MongooseSchema({text:String,userId:{type:i,ref:"User"},animeId:{type:i,ref:"Anime"},likes:[{type:i,ref:"User"}],replies:[{type:i,ref:"Comment"}]},{timestamps:!0});t.default=r.model("comment",s)},function(e,t){e.exports=require("superagent")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),o=n(19),i=n(21);t.default=r.Router().use("/",o.default).use("/anime/:animeId/comments",i.default)},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),i=n(3),s=n(7),a=n(4);t.default=o.Router().get("/me",i.default("get:basic","get:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{user:r}=e;return t.status(200).json(r)}catch(e){n(e)}})).patch("/me",i.default("patch:basic","patch:admin"),s.validationHandler({username:s.SLUG(16),photo:s.URI(256),firstName:s.NAME(16),lastName:s.NAME(16)}),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,user:o,body:i}=e,s=yield r.users.updateOne({_id:o._id},{$set:i}).exec();return t.status(200).json({message:`Modified ${s.ok} document[s]`})}catch(e){n(e)}})).delete("/me",i.default("delete:basic","delete:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,user:o}=e;yield r.users.deleteOne({_id:o._id}).exec(),t.status(204).end()}catch(e){n(e)}})).get("/users",i.default("get:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,query:o}=e,i=yield r.users.find({username:new RegExp(`.*${o.username}.*`),firstName:new RegExp(`.*${o.firstName}.*`),lastName:new RegExp(`.*${o.lastName}.*`)}).exec();return t.status(200).json(i)}catch(e){n(e)}})).patch("/users/:id",i.default("patch:admin"),s.validationHandler({permissions:s.ARRAY(s.ENUM(i.possiblePermissions)),username:s.SLUG(16),photo:s.URI(256),firstName:s.NAME(16),lastName:s.NAME(16)}),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,params:o,body:i}=e,s=yield r.users.findById(o.id).exec();return s?s.toObject().permissions.some(e=>"overlord"===e)?n(new a.PermissionError):(yield s.update({$set:i}).exec(),t.status(204).end()):n(new a.NotFoundError("User not found"))}catch(e){n(e)}}))},function(e,t){e.exports=require("joi")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function a(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}u((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),i=n(3),s=n(7);t.default=o.Router().patch("/:id/likes",i.default("patch:basic","patch:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,user:o,params:i}=e,s=(yield r.comments.findById(i.id).exec()).toObject().likes.includes(o._id)?"$pull":"$push",a=yield r.comments.findByIdAndUpdate(i.id,{[s]:{likes:o._id}},{new:!0}).exec();return t.status(200).json(a)}catch(e){n(e)}})).post("/",i.default("post:basic","post:admin"),s.validationHandler({text:s.$VARCHAR(300),animeId:s.$GUID(),replies:s.ARRAY(s.GUID()),likes:s.ARRAY(s.GUID())}),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{body:r,user:o,db:i}=e,s=new i.comments(Object.assign({},r,{userId:o._id}));return t.status(201).json(yield s.save())}catch(e){n(e)}})).patch("/:id",i.default("patch:basic","patch:admin"),s.validationHandler({text:s.$VARCHAR(300)}),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,user:o,params:i,body:s}=e,a=yield r.comment.updateOne({_id:i.id,userId:o._id},{$set:{text:s.text}},{new:!0}).exec();return t.status(a.ok<1?400:200).json({result:a})}catch(e){n(e)}})).delete("/:id",i.default("delete:basic","delete:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,user:o,params:i}=e,s=yield r.comment.deleteOne({_id:i.id,userId:o._id}).error();return t.status(204).json(s)}catch(e){n(e)}})).delete("/:id",i.default("delete:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{db:r,params:o}=e,i=yield r.comment.deleteOne({_id:o.id}).error();return t.status(204).json(i)}catch(e){n(e)}})).get("/",i.default("get:admin"),(e,t,n)=>r(this,void 0,void 0,function*(){try{const{text:r="",userId:o=""}=e.query,{db:i}=e,s=yield i.comment.find({text:new RegExp(`.*${r}.*`),userId:new RegExp(`.*${o}.*`)});return t.status(204).json(s)}catch(e){n(e)}}))}]);