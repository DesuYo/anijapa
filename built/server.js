!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,u)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),i=n(4),s=n(15),u={member:0,admin:1,overlord:2};class a{constructor(e){this.message=e}}t.PermissionError=a,t.googleAuthorize=(e=>(t,n,r)=>o(this,void 0,void 0,function*(){try{const{path:o}=t,{GOOGLE_ID:i}=process.env;n.redirect("https://accounts.google.com/o/oauth2/v2/auth"+`?client_id=${i}`+`&redirect_uri=https://${t.get("host")}${o}/callback`+`&scope=${e}`+"&response_type=code")}catch(e){r(e)}})),t.googleCallback=(()=>(e,t,n)=>o(this,void 0,void 0,function*(){try{const{path:o,query:i,db:u}=e,{GOOGLE_ID:a,GOOGLE_SECRET:c,JWT_SECRET:d}=process.env,{access_token:l}=(yield s.post("https://www.googleapis.com/oauth2/v4/token").set("accept","application/json").set("content-type","application/x-www-form-urlencoded").send({client_id:a,client_secret:c,code:i.code,redirect_uri:`https://${e.get("host")}${o}`,grant_type:"authorization_code"})).body,f=(yield s.get("https://www.googleapis.com/oauth2/v1/userinfo").set("accept","application/json").query({access_token:l})).body;let p=yield u.users.findOne({googleID:f.id}).exec();if(p)return t.status(200).json({accessToken:r.sign({_id:p.toObject()._id},d,{expiresIn:"2d"}),tokenType:"Bearer"});const{id:h,given_name:m,family_name:y,picture:v}=f;return p=(yield u.users.create({googleID:h,firstName:m,lastName:y,photo:v})).toObject(),t.status(201).json({accessToken:r.sign({_id:p._id},d,{expiresIn:"2d"}),tokenType:"Bearer"})}catch(e){return n(e)}})),t.default=(e=>(t,n,s)=>o(this,void 0,void 0,function*(){try{const{authorization:n}=t.headers;n||s(new r.JsonWebTokenError("Bearer token is required!"));const[o,c]=n.split(" ");"Bearer"!==o&&s(new r.JsonWebTokenError("Bearer token is required!"));const{_id:d}=r.verify(c,process.env.JWT_SECRET||"難しい鍵"),l=yield i.default.findById(d,{__v:0}).exec();l||s(new r.JsonWebTokenError("User with this token does not exist"));const f=l.toObject();u[f.role]<u[e]&&s(new a("Permission denied for this action")),t.user=f,s()}catch(e){s(e)}}))},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(2);t.default=o.model("user",new o.Schema({googleID:{type:String,unique:!0},username:{type:String,sparse:!0},firstName:String,lastName:String,birthDate:Date,photo:String},{timestamps:!0}).pre("save",()=>{}))},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,u)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(18),i=e=>r.string().trim().max(e),s=e=>r.number().max(e),u=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$/;t.VARCHAR=((e,t)=>i(e).default(t)),t.$VARCHAR=(e=>i(e).required()),t.GUID=(e=>i(64).guid().default(e)),t.$GUID=(()=>i(64).guid().required()),t.ARRAY=((...e)=>r.array().items(e).default([])),t.$ARRAY=((...e)=>r.array().items(e).required()),t.SLUG=((e,t)=>i(e).token().lowercase().default(t)),t.$SLUG=(e=>i(e).token().lowercase().required()),t.URI=((e,t)=>i(e).uri({allowRelative:!0}).default(t)),t.$URI=(e=>i(e).uri({allowRelative:!0}).required()),t.NAME=((e,t)=>i(e).regex(/^[a-zA-Z]$/).default(t)),t.$NAME=(e=>i(e).regex(/^[a-zA-Z]$/).required()),t.EMAIL=(e=>i(64).email().default(e)),t.$EMAIL=(()=>i(64).email().required()),t.PHONE=(e=>i(16).replace(/\(*\)*/g,"").regex(/^\+\d{11,12}$/).default(e)),t.$PHONE=(()=>i(16).replace(/\(*\)*/g,"").regex(/^\+\d{11,12}$/).required()),t.PASSWORD=((e,t)=>i(64).regex(u).min(e).default(t)),t.$PASSWORD=(e=>i(64).regex(u).min(e).required()),t.INT=((e=Math.pow(2,32),t)=>s(e).integer().default(t)),t.$INT=((e=Math.pow(2,32))=>s(e).integer().required()),t.UINT=((e=Math.pow(2,32),t)=>s(e).integer().positive().default(t)),t.$UINT=((e=Math.pow(2,32))=>s(e).integer().positive().required()),t.FLOAT=((e=Math.pow(2,32),t=3,n)=>s(e).precision(t).default(n)),t.$FLOAT=((e=Math.pow(2,32),t=3)=>s(e).precision(t).required()),t.UFLOAT=((e=Math.pow(2,32),t=3,n)=>s(e).precision(t).positive().default(n)),t.$UFLOAT=((e=Math.pow(2,32),t=3)=>s(e).precision(t).positive().required()),t.BOOL=(e=>r.boolean().default(e)),t.DATE=(e=>r.date().iso().default(e)),t.$DATE=(()=>r.date().iso().required()),t.validationHandler=(e=>(t,n,i)=>o(this,void 0,void 0,function*(){try{const{error:n,value:o}=r.compile(e).options({abortEarly:!1,allowUnknown:!0,stripUnknown:!0}).validate(t.body);return n&&i(n),t.body=o,i()}catch(e){i(e)}}))},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0});const o=n(7),r=n(0),i=n(8),s=n(9),u=n(10),a=n(11),c=n(12),d=n(1),l=n(16),f=n(21);o.config();const{PORT:p=777}=process.env;t.default=r().use(u("dev")).use(s()).use(r.static(a.join(e,"..","client"))).use(i.json()).use(i.urlencoded({extended:!0})).use(c.default).get("/google",d.googleAuthorize("https://www.googleapis.com/auth/userinfo.profile")).all("/google/callback",d.googleCallback()).use("/api",l.default).use((e,t)=>t.status(200).sendFile("/index.html")).use(f.default).listen(p,()=>console.log("I'm gonna poop on the plate, bratok..."))}).call(this,"/")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,u)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(2),i=n(13);t.default=((e,t,n)=>o(this,void 0,void 0,function*(){try{const{DB_URI:t}=process.env;yield r.connect(t,{useNewUrlParser:!0}),e.db=i.default,n()}catch(e){n(e)}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(4),r=n(14);t.default={users:o.default,comments:r.default}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(2),r=o.Schema.Types.ObjectId,i=new o.Schema({text:String,userId:{type:r,ref:"User"},animeId:{type:r,ref:"Anime"},likes:[{type:r,ref:"User"}],replies:[{type:r,ref:"Comment"}]},{timestamps:!0});t.default=o.model("comment",i)},function(e,t){e.exports=require("superagent")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(0),r=n(17),i=n(20);t.default=o.Router().use("/",r.default).use("/anime/:animeId/comments",i.default)},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,u)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),i=n(1),s=n(5),u=n(3),a=n(19);t.default=r.Router().post("/signup",s.validationHandler({username:s.$SLUG(16),email:s.$EMAIL(),password:s.$PASSWORD(8)}),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{db:o,body:r}=e,{_id:i}=(yield o.users.create(Object.assign({},r,{password:a.hashSync(r.password)}))).toObject();return t.status(201).json({token:u.sign({_id:i},process.env.JWT_SECRET||"難しい鍵")})}catch(e){n(e)}})).patch("/me",i.default("member"),s.validationHandler({password:s.$VARCHAR(256),username:s.SLUG(16),firstName:s.NAME(16),lastName:s.NAME(16),birthDate:s.DATE(),photo:s.URI(256)}),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{db:o,user:r,body:i}=e,s=yield o.users.updateOne({_id:r._id},{$set:i}).exec();return t.status(200).json({message:`Modified ${s.ok} document[s]`})}catch(e){n(e)}})).get("/me",i.default("member"),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{user:o}=e;return t.status(200).json(o)}catch(e){n(e)}}))},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("bcryptjs")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function u(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,u)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),i=n(1),s=n(5);t.default=r.Router().patch("/:id/likes",i.default("member"),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{db:o,user:r,params:i}=e,s=(yield o.comments.findById(i.id).exec()).toObject().likes.includes(r._id)?"$pull":"$push",u=yield o.comments.findByIdAndUpdate(i.id,{[s]:{likes:r._id}},{new:!0}).exec();return t.status(200).json(u)}catch(e){n(e)}})).post("/",i.default("member"),s.validationHandler({text:s.$VARCHAR(300),animeId:s.$GUID(),replies:s.ARRAY(s.GUID()),likes:s.ARRAY(s.GUID())}),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{body:o,user:r,db:i}=e;return t.status(201).json(yield i.comments.create(Object.assign({},o,{userId:r._id})))}catch(e){n(e)}})).patch("/:id",i.default("member"),s.validationHandler({text:s.$VARCHAR(300)}),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{db:o,user:r,params:i,body:s}=e,u=yield o.comment.updateOne({_id:i.id,userId:r._id},{$set:{text:s.text}},{new:!0}).exec();return t.status(u.ok<1?400:200).json({result:u})}catch(e){n(e)}})).delete("/:id",i.default("member"),(e,t,n)=>o(this,void 0,void 0,function*(){try{const{db:o,user:r,params:i,body:s}=e,u=yield o.comment.deleteOne({_id:i.id,userId:r._id}).error();return t.status(200).json(u)}catch(e){n(e)}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(3),r=n(1);t.default=((e,t,n,i)=>{try{switch(!0){case e instanceof o.JsonWebTokenError||e instanceof o.TokenExpiredError:return n.status(401).json({error:e});case e instanceof r.PermissionError:return n.status(403).json({error:e});case e.isJoi:return n.status(400).json(e.details.map(e=>({key:e.context.key,message:e.message})));case"MongoError"===e.name&&11e3===e.code:return n.status(400).json({error:e.errmsg});default:throw e}}catch(e){return n.status(500).json({error:e.message||e})}})}]);